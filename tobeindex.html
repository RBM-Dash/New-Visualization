<!DOCTYPE html>
<html>

<head>
    <script src="js/papaparse.min.js"></script>
    <script src="js/lodash.min.js"></script>
    <script src="js/echarts.min.js" type="text/javascript"></script>
    <script src="js/Utils.js" type="text/javascript"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>
    <title>GAPS</title>
    <div style="position:relative" class="gantt" id="GanttChartDIV"></div>
</body>
<script>
    


                                function onlyUnique(value, index, self) {

                                    self.indexOf(value) === index;
                                }

                                function decoupleObject(Objeto, toSplit) {
                                    // Loop over an object to split a given list of keys (toSplit) with complex names into several properties and adds them as new key/values pairs
                                    let Accumulator = [];
                                    let tocorrectKeys = [];
                                    let temp = [];
                                    let splittedM = [];
                                    tocorrectKeys = _.intersection(_.keys(Objeto[0]), toSplit);

                                    for (let i = 0; i < Objeto.length; i++) {
                                        for (let j = 0; j < tocorrectKeys.length; j++) {
                                            temp = _.pick(Objeto[i], ['Country', 'ISO3', 'WHO_Region', tocorrectKeys[j]]);
                                            splittedM = _.split(tocorrectKeys[j], '_', 6);
                                            temp.category = splittedM[0];
                                            temp.Year = parseFloat(splittedM[2]);
                                            temp.whichIs = splittedM[1];
                                            temp.value = (temp[tocorrectKeys[j]]);
                                            Accumulator = _.concat(Accumulator, temp);
                                        }
                                    }
                                    return Accumulator;
                                }

                                function myOptionMap(myData, myContainer, myMapURL) {
                                    //Return the basic config option for a simple makeInput
                                    //myEncode is the category of commodities 

                                    var chart = echarts.init(document.getElementById(myContainer));
                                    chart.setOption({

                                        dataset: [{
                                            id: 'dataset_raw',
                                            source: myData
                                        }, {
                                            id: 'Needs',
                                            fromDatasetId: 'dataset_raw',
                                            transform: {
                                                type: 'filter',
                                                config: {
                                                    and: [{
                                                        dimension: 'whichIs',
                                                        '=': 'Needs'
                                                    }]
                                                },
                                                print: true
                                            },

                                        }, {
                                            id: 'Financed',
                                            fromDatasetId: 'dataset_raw',
                                            transform: {
                                                type: 'filter',
                                                config: {
                                                    and: [{
                                                        dimension: 'whichIs',
                                                        '=': 'Financed'
                                                    }]
                                                },
                                                print: true
                                            },

                                        }, {
                                            id: 'GAPS',
                                            fromDatasetId: 'dataset_raw',
                                            transform: {
                                                type: 'filter',
                                                config: {
                                                    and: [{
                                                        dimension: 'whichIs',
                                                        '=': 'GAPS'
                                                    }]
                                                },
                                                print: true
                                            },

                                        }, ],

                                        legend: {

                                            orient: 'horizontal',
                                            left: 'left',
                                            width: '100%',
                                            itemGap: 6,
                                            itemWidth: 15,
                                            itemHeight: 10,
                                            data: ['Needs', 'Financed', 'GAPS'],
                                            selected: {
                                                'Needs': false,
                                                'Financed': false,
                                                'GAPS': true,
                                            },

                                        },
                                        visualMap: {
                                            left: 'right',
                                            min: 5,
                                            max: 38000000,
                                            inRange: {
                                                color: [
                                                    '#313695',
                                                    '#4575b4',
                                                    '#74add1',
                                                    '#abd9e9',
                                                    '#e0f3f8',
                                                    '#ffffbf',
                                                    '#fee090',
                                                    '#fdae61',
                                                    '#f46d43',
                                                    '#d73027',
                                                    '#a50026'
                                                ]
                                            },
                                            text: ['High', 'Low'],
                                            calculable: true
                                        },
                                        /* toolbox: myToolbox,
                                        grid: myGrid,
                                        xAxis: myXAxis,
                                        yAxis: [{
                                            type: 'category',
                                            inverse: true,
                                            data: titledata4,
                                            axisTick: {
                                                alignWithLabel: true
                                            }
                                        }], */
                                        geo: {
                                            id: "myGeo",
                                            map: "world",
                                            left: '1%',
                                            right: '35%',
                                            top: 100,
                                            bottom: "5%",
                                            zoom: 0.75,
                                            roam: true,
                                            label: {
                                                normal: {
                                                    show: false
                                                },
                                                emphasis: {
                                                    show: true,
                                                    fontFamily: '"Helvetica", Helvetica',
                                                    color: "rgba(255,255,255,.7)",
                                                    backgroundColor: "rgba(0, 0, 0, 0.4)",
                                                    borderRadius: 4,
                                                    padding: 4,
                                                    borderWidth: .1,
                                                    borderColor: "rgb(65,65,65,0.5)"
                                                }
                                            },

                                        },
                                        series: [{
                                            name: 'gNeeds',
                                            //geoIndex: 0,
                                            type: 'map',
                                            mapType: "world",
                                            left: '1%',
                                            right: '35%',
                                            top: 100,
                                            bottom: "5%",
                                            zoom: 0.75,
                                            nameMap: {
                                                'Central African Republic': 'CAR',
                                                'Democratic Republic of the Congo': 'DRC',
                                                'United Republic of Tanzania': 'Tanzania',
                                                'Lao Peoples Democratic Republic': 'Laos',
                                                'Venezuela (Bolivarian Republic of)': 'Venezuela'
                                            },
                                            datasetId: 'Needs',
                                            encode: {
                                                name: 'Country',
                                                value: 'value',
                                            }
                                        }, {
                                            z: 3,
                                            datasetId: 'Financed',
                                            type: 'map',
                                            encode: {
                                                name: 'Country',
                                                value: 'value',
                                            }
                                        }, {
                                            z: 3,
                                            datasetId: 'GAPS',
                                            type: 'map',
                                            encode: {
                                                name: 'Country',
                                                value: 'value',
                                            }
                                        }],




                                    });
                                };


                                const masterSheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw8oYQjlGERaqSIxTVy12iD5hh6ZXpSOhppwDjA4zkqk9WcDc5J5ne1lHnuRqbNjOU07fFxOFIdGQD/pub?output=csv";
                                Papa.parse(masterSheetURL, {

                                        download: true,
                                        header: true,
                                        dynamicTyping: true,
                                        skipEmptyLines: 'greedy',
                                        complete: function(results) {
                                            //Remove null countries
                                            console.log(results)
                                            results = _.reject(results.data, {
                                                'Country': null
                                            });
                                            //Keep latest records for display. Oldest ones of no interest right now
                                            let myKeyed = _.groupBy(results, 'Updated')
                                            const updateDate = _.max(_.keys(myKeyed));
                                            results = myKeyed[updateDate];
                                            //console.log(results);
                                            // Register Map
                                            echarts.registerMap("world", worldJson, {
                                                Ghana: {

                                                    left: -127,
                                                    top: 25,
                                                    width: 15,
                                                }
                                            });

                                            let myKeys = _.pullAll(_.keys(results[0]), ['Country', 'ISO3', 'Updated', 'WHO_Region', 'Total_Financed_2021_2023', 'Total_GAP_2021_2023', 'Total_Needs_2021_2023']);

                                            let allKeys = decoupleObject(results, myKeys);
                                            console.log(allKeys);
                                            //Create values for the info-boxes


                                            let databyCat = _.groupBy(allKeys, 'category');
                                            let allLLIN = _.values(databyCat["LLIN"]);

                                            console.log(allLLIN)
                                            console.log(databyCat)
                                            var myChart = echarts.init(document.getElementById('GanttChartDIV'));
                                            option = {
                                                title: [{
                                                    text: "Global NSP Needs: " + sum1,
                                                    right: 320,
                                                    top: 20,
                                                    width: 100,
                                                    textStyle: {
                                                        color: "#000",
                                                        fontSize: 16,
                                                    },
                                                }, {
                                                    text: "Global NSP GAPs: " + sum0,
                                                    right: 120,
                                                    top: 20,
                                                    width: 100,
                                                    textStyle: {
                                                        color: "#000",
                                                        fontSize: 16,
                                                    },
                                                }, {
                                                    text: "Global NSP Financed: " + sum2,
                                                    right: 130,
                                                    top: 40,
                                                    width: 100,
                                                    textStyle: {
                                                        color: "#000",
                                                        fontSize: 16,
                                                    },
                                                }],
                                                tooltip: {
                                                    trigger: "item",
                                                },
                                                legend: {
                                                    orient: "vertical",
                                                    left: "left",
                                                    data: ["Needs", "GAPS", "Financed"],
                                                    selectedMode: "single",
                                                },
                                                visualMap: {
                                                    min: 0,
                                                    max: 3000000,
                                                    left: "center",
                                                    top: "bottom",
                                                    //text: ["高", "低"],
                                                    calculable: true,
                                                    colorLightness: [0.2, 100],
                                                    color: ["#ff0000", "#c05050", "#e5cf0d", "#5ab1ef"],
                                                    dimension: 0,
                                                },
                                                // toolbox: {
                                                // 	show: true,
                                                // 	orient: 'vertical',
                                                // 	left: 'right',
                                                // 	top: 'center',
                                                // 	feature: {
                                                // 		dataView: {
                                                // 			readOnly: false,
                                                // 		},
                                                // 		restore: {},
                                                // 		saveAsImage: {},
                                                // 	},
                                                // },
                                                grid: {
                                                    right: 40,
                                                    top: 100,
                                                    bottom: 0,
                                                    width: "30%",
                                                },
                                                xAxis: [{
                                                    position: "top",
                                                    type: "value",
                                                    boundaryGap: false,
                                                    splitLine: {
                                                        show: false,
                                                    },
                                                    axisLine: {
                                                        show: false,
                                                    },
                                                    axisTick: {
                                                        show: false,
                                                    },
                                                }, ],
                                                yAxis: [{
                                                    type: "category",
                                                    data: titledata,
                                                    axisTick: {
                                                        alignWithLabel: true,
                                                    },
                                                    axisLabel: {
                                                        show: true,
                                                        textStyle: {

                                                            fontSize: 11,
                                                        },
                                                    },
                                                    data: yData,
                                                }, ],
                                                series: [{
                                                        z: 1,
                                                        name: "Needs",
                                                        type: "map",
                                                        map: "world",
                                                        left: "10",
                                                        right: "35%",
                                                        top: 1,
                                                        bottom: "25%",
                                                        zoom: 1,
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        //roam: true,
                                                        data: resultdata0,
                                                    }, {
                                                        z: 1,
                                                        name: "GAPS",
                                                        type: "map",
                                                        map: "world",
                                                        left: "10",
                                                        right: "35%",
                                                        top: 1,
                                                        bottom: "35%",
                                                        zoom: 0.75,
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        //roam: true,
                                                        data: resultdata1,
                                                    }, {
                                                        z: 1,
                                                        name: "Financed",
                                                        type: "map",
                                                        map: "world",
                                                        left: "10",
                                                        right: "35%",
                                                        top: 1,
                                                        bottom: "35%",
                                                        zoom: 0.75,
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        //roam: true,
                                                        data: resultdata2,
                                                    },

                                                    {
                                                        name: "Needs",
                                                        z: 2,
                                                        type: "bar",
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                                position: "right",
                                                                fontSize: 10,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        itemStyle: {
                                                            emphasis: {
                                                                color: "rgb(254,153,78)",
                                                            },
                                                        },
                                                        barWidth: 5,
                                                        data: resultdata0,
                                                    }, {
                                                        name: "GAPS",
                                                        z: 2,
                                                        type: "bar",
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                                position: "right",
                                                                fontSize: 10,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        itemStyle: {
                                                            emphasis: {
                                                                color: "rgb(254,153,78)",
                                                            },
                                                        },
                                                        barWidth: 5,
                                                        data: resultdata1,
                                                    }, {
                                                        name: "Financed",
                                                        z: 2,
                                                        type: "bar",
                                                        label: {
                                                            normal: {
                                                                show: true,
                                                                position: "right",
                                                                fontSize: 10,
                                                            },
                                                            emphasis: {
                                                                show: true,
                                                            },
                                                        },
                                                        itemStyle: {
                                                            emphasis: {
                                                                color: "rgb(254,153,78)",
                                                            },
                                                        },
                                                        barWidth: 5,

                                                        data: resultdata2,
                                                    },

                                                ],
                                            };
                                            myChart.setOption(option);

                                            // Echarts Resize
                                            window.addEventListener("resize", () => {
                                                myChart.resize(); //resize 
                                            });
                                            myOptionMap(allLLIN, 'GanttChartDIV', uploadedDataURL);
                                            //myChart.setOption(option);
                                            //Create values for the info-boxes

                                        }
                                    })
</script>

</html>
 